{{- if (and .Values.grafanaDashboard.enabled (eq .Values.grafanaDashboard.mode "Sidecar")) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spegel.fullname" . }}-dashboard
  namespace: {{ include "spegel.namespace" . }}
  labels:
    {{- include "spegel.labels" . | nindent 4 }}
    {{- with .Values.grafanaDashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.grafanaDashboard.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
    spegel.json: |-
{{ .Files.Get "monitoring/grafana-dashboard.json" | indent 6 }}
{{- end }}
{{- if (and .Values.grafanaDashboard.enabled (eq .Values.grafanaDashboard.mode "GrafanaOperator")) -}}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ include "spegel.fullname" . }}
  namespace: {{ include "spegel.namespace" . }}
  labels:
    {{- include "spegel.labels" . | nindent 4 }}
    {{- with .Values.grafanaDashboard.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  allowCrossNamespaceImport: {{ .Values.grafanaDashboard.grafanaOperator.allowCrossNamespaceImport }}
  resyncPeriod: {{ .Values.grafanaDashboard.grafanaOperator.resyncPeriod | quote | default "10m" }}
  {{- with .Values.grafanaDashboard.grafanaOperator.folder }}
  folder: {{ . | quote }}
  {{- end }}
  instanceSelector:
    matchLabels:
    {{- if .Values.grafanaDashboard.grafanaOperator.matchLabels }}
      {{- toYaml .Values.grafanaDashboard.grafanaOperator.matchLabels | nindent 6 }}
    {{- else }}
      {{- fail "grafanaDashboard.grafanaOperator.matchLabels must be specified when grafanaDashboard.grafanaOperator.enabled is true" }}
    {{- end }}
  json: |-
{{ .Files.Get "monitoring/grafana-dashboard.json" | indent 4 }}
{{- end }}
